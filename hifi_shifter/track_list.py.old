from PyQt6.QtWidgets import QListWidget, QListWidgetItem, QWidget, QHBoxLayout, QLabel, QPushButton, QMenu
from PyQt6.QtCore import Qt, pyqtSignal

class TrackItemWidget(QWidget):
    mute_toggled = pyqtSignal(bool)
    solo_toggled = pyqtSignal(bool)

    def __init__(self, track):
        super().__init__()
        self.track = track
        layout = QHBoxLayout(self)
        layout.setContentsMargins(5, 2, 5, 2)
        
        self.name_label = QLabel(track.name)
        if track.track_type == 'bgm':
            self.name_label.setStyleSheet("color: #888888;")
            
        self.mute_btn = QPushButton("M")
        self.mute_btn.setCheckable(True)
        self.mute_btn.setFixedWidth(25)
        self.mute_btn.setChecked(track.muted)
        self.mute_btn.clicked.connect(self.on_mute)
        
        self.solo_btn = QPushButton("S")
        self.solo_btn.setCheckable(True)
        self.solo_btn.setFixedWidth(25)
        self.solo_btn.setChecked(track.solo)
        self.solo_btn.clicked.connect(self.on_solo)
        
        layout.addWidget(self.name_label)
        layout.addStretch()
        layout.addWidget(self.mute_btn)
        layout.addWidget(self.solo_btn)
        
    def on_mute(self, checked):
        self.track.muted = checked
        self.mute_toggled.emit(checked)
        
    def on_solo(self, checked):
        self.track.solo = checked
        self.solo_toggled.emit(checked)

class TrackListWidget(QListWidget):
    track_selected = pyqtSignal(int) # index
    files_dropped = pyqtSignal(list) # list of file paths
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAcceptDrops(True)
        self.setDragDropMode(QListWidget.DragDropMode.DropOnly)
        self.currentRowChanged.connect(self.on_row_changed)
        self.setFixedWidth(250)
        
    def add_track(self, track):
        item = QListWidgetItem()
        widget = TrackItemWidget(track)
        item.setSizeHint(widget.sizeHint())
        self.addItem(item)
        self.setItemWidget(item, widget)
        
        # Connect signals to refresh playback if needed
        # widget.mute_toggled.connect(...) 
        
    def on_row_changed(self, row):
        if row >= 0:
            self.track_selected.emit(row)
            
    def dragEnterEvent(self, event):
        if event.mimeData().hasUrls():
            event.accept()
        else:
            event.ignore()
            
    def dragMoveEvent(self, event):
        if event.mimeData().hasUrls():
            event.accept()
        else:
            event.ignore()
            
    def dropEvent(self, event):
        files = [u.toLocalFile() for u in event.mimeData().urls()]
        if files:
            self.files_dropped.emit(files)

    def contextMenuEvent(self, event):
        item = self.itemAt(event.pos())
        if item:
            widget = self.itemWidget(item)
            track = widget.track
            
            menu = QMenu(self)
            
            if track.track_type == 'vocal':
                action = menu.addAction("转换为 BGM (不修音)")
                action.triggered.connect(lambda: self.parent().convert_track_type(track, 'bgm'))
            else:
                action = menu.addAction("转换为人声 (可修音)")
                action.triggered.connect(lambda: self.parent().convert_track_type(track, 'vocal'))
                
            menu.exec(event.globalPos())
